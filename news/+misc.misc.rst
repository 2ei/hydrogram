Misc fixes, improvements and micro optimizations.
